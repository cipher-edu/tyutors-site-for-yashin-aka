{% extends 'base.html' %} {# Assumed base template exists #}
{% load static %} {# If using static files #}

{% block title %}{{ course.title }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>{{ course.title }}</h1>
    {# Ensure 'core' is your actual app_name used in urls.py #}
    <a href="{% url 'learning_platform:module_detail' pk=course.module.pk %}" class="btn btn-secondary btn-sm">
        <i class="fas fa-arrow-left"></i> {{ course.module.title }} moduliga qaytish
    </a>
</div>

<div class="card">
    <div class="card-content">
        {# Use the model property to get the correct embed URL #}
        {% with embed_url=course.get_youtube_embed_url %}
            {% if embed_url %}
            {# Video Section - Only displayed if a valid embed URL is generated #}
            <div style="margin-bottom: 25px; position: relative; padding-bottom: 56.25%; /* 16:9 aspect ratio */ height: 0; overflow: hidden; background-color: #eee; /* Placeholder background */ max-width: 100%;">
                <iframe
                    style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; border-radius: var(--border-radius);" {# Removed frameborder, border:none is better #}
                    src="{{ embed_url }}" {# << CORRECT: Using the model property #}
                    title="YouTube video player: {{ course.title|escape }}" {# Added title for accessibility #}
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                    referrerpolicy="strict-origin-when-cross-origin" {# Recommended policy #}
                    allowfullscreen>
                 </iframe>
                 {# Fallback message if iframe doesn't load - less likely needed now #}
                 <p style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #555;">Video yuklanmoqda...</p>
            </div>
            <hr>
            {% elif course.video_url %}
                {# Message if URL exists but couldn't be converted #}
                 <p class="card-text text-muted" style="color: var(--gray);">
                     <i class="fas fa-exclamation-triangle"></i> Video havolasi mavjud, lekin uni pleerga joylashtirib bo ªlmadi. Havola formatini tekshiring (YouTube standart yoki qisqa link).
                 </p>
                 <hr>
            {% endif %}
            {# End of video section check #}
        {% endwith %}

        {# Course Content Section #}
        <h3 class="card-title" style="margin-top: 15px;">Dars Mazmuni</h3>
        <div class="card-text course-main-content" style="line-height: 1.7;">
            {# Use linebreaksbr if you just want line breaks, or linebreaks for paragraphs #}
            {# Add 'safe' if your content contains trusted HTML, otherwise omit it for security #}
            {{ course.content|linebreaksbr|safe }}
        </div>

        <hr style="margin-top: 30px; margin-bottom: 20px;">

        {# Completion Button/Status Section #}
        {% if user.is_authenticated %} {# Only show for logged-in users #}
            {% if not is_completed %}
            <form method="post" action="{% url 'learning_platform:mark_course_complete' pk=course.pk %}" style="display: inline;"> {# Check app_name 'core' #}
                 {% csrf_token %}
                <button type="submit" class="btn btn-success">
                     <i class="fas fa-check-circle"></i> Tugatildi deb belgilash
                </button>
            </form>
            {% else %}
            <p style="color: #28a745; font-weight: bold;"> {# Green color for success #}
                <i class="fas fa-check-circle"></i> Siz bu kursni muvaffaqiyatli tugatgansiz.
            </p>
            {% endif %}
        {% endif %} {# End user.is_authenticated check #}

    </div> {# End card-content #}
</div> {# End card #}

{% endblock %}